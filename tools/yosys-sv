#!/usr/bin/env bash
set -euo pipefail

CANDIDATES=()
if [[ -n "${YOSYS_SV_BIN:-}" ]]; then
  CANDIDATES+=("$YOSYS_SV_BIN")
fi
if [[ -x "$HOME/synlig-local/bin/yosys" ]]; then
  CANDIDATES+=("$HOME/synlig-local/bin/yosys")
fi
if [[ -x "$HOME/oss-cad-suite/bin/yosys" ]]; then
  CANDIDATES+=("$HOME/oss-cad-suite/bin/yosys")
fi
CANDIDATES+=("yosys")

pick=""
for bin in "${CANDIDATES[@]}"; do
  if command -v "$bin" >/dev/null 2>&1; then
    pick="$(command -v "$bin")"
    break
  fi
done

if [[ -z "$pick" ]]; then
  echo "[yosys-sv] no yosys found" >&2
  exit 127
fi

root="$(dirname "$(dirname "$pick")")"
mod1="$root/share/yosys/plugins/systemverilog.so"
mod2="$root/lib/yosys/plugins/systemverilog.so"
mod=""
for m in "$mod1" "$mod2"; do
  if [[ -f "$m" ]]; then
    mod="$m"
    break
  fi
done

args=()
if [[ -n "$mod" ]]; then
  export LD_LIBRARY_PATH="${root}/lib:${LD_LIBRARY_PATH:-}"
  args=(-m "$mod")
fi

exec "$pick" "${args[@]}" "$@"
